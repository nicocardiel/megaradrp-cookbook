

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CR not removed by median stacking &mdash; megara-cookbook 2025.05.16 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=cecfaa16"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="MEGARA Tools" href="megaratools.html" />
    <link rel="prev" title="Healing Defective Traces" href="healtraces.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            megara-cookbook
              <img src="_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="megaradrp.html">MEGARA Data Reduction Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">DRP installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="datadesc.html">Data description</a></li>
<li class="toctree-l1"><a class="reference internal" href="datared.html">Data reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="healtraces.html">Healing Defective Traces</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">CR not removed by median stacking</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#the-mediancr-method">The mediancr method</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="megaratools.html">MEGARA Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="issues.html">Known ISSUES</a></li>
<li class="toctree-l1"><a class="reference internal" href="acronyms.html">Acronyms</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">megara-cookbook</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">CR not removed by median stacking</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/mediancr.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="cr-not-removed-by-median-stacking">
<span id="fixing-cr-median"></span><h1>CR not removed by median stacking<a class="headerlink" href="#cr-not-removed-by-median-stacking" title="Link to this heading"></a></h1>
<p>The different recipes in MEGARA DRP use by default a median combination of
three or more images to obtain an average exposure and thus eliminate cosmic
rays. However, when exposure times are long, it is not uncommon for the same
pixel to be affected by a cosmic ray in consecutive exposures.</p>
<p>The most obvious initial solution is to closely examine the resulting image
(e.g., the <code class="docutils literal notranslate"><span class="pre">final_rss.fits</span></code> file) and interpolate the defective pixels using
information from neighboring pixels. However, it may be useful to employ a
procedure that automatically detects and corrects pixels affected by cosmic
rays in consecutive images, so that manual interpolation is not necessary. An
automatic procedure of this kind has been introduced in the <strong>numina</strong> package,
which can be easily invoked by modifying the default image combination method
used by MEGARA DRP.</p>
<section id="the-mediancr-method">
<h2>The mediancr method<a class="headerlink" href="#the-mediancr-method" title="Link to this heading"></a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is important to note that the ad hoc method described here is susceptible
to detecting false positives and should be tested and compared with the
default method (simple median combination).</p>
<p><strong>The method has been tested on a limited subset of images and is not
guaranteed to work optimally in general cases. Users should be aware of this
limitation and use the method at their own discretion.</strong></p>
<p>By properly adjusting the detection parameters, <strong>typically by trial and
error</strong>, it is possible to minimize the number of false detections. On the
other hand, the signal in pixels affected by a false multiple cosmic ray
detection is replaced by the minimum value at each pixel (across the
available exposures), so the impact on the combined image is not expected to
be severe. The benefit of automatically removing pixels affected by more
than one cosmic ray in the different exposures can outweigh this effect.</p>
<p>The described method is likely only useful when reducing science images with
long exposure times. In general, it is not recommended for the reduction of
calibration images.</p>
</div>
<p>The method can only be employed when there are three or more exposures
available, and is based on detecting pixels that simultaneously verify three
different criteria. The first two of them are shown in the following figure,
which is automically generated in the <em>work</em> subdirectory with the name
<code class="docutils literal notranslate"><span class="pre">mediancr_diagnostic.png</span></code>.</p>
<a class="reference internal image-reference" href="_images/mediancr_diagnostic.png"><img alt="diagnostic diagram to detect double cosmic rays in median combination" src="_images/mediancr_diagnostic.png" style="width: 100%;" />
</a>
<p>The three (or more) available individual exposures are arranged into a 3D
stack, from which it is easy to generate 2D images (with the same dimensions as
the individual exposures) that contain the minimum value <code class="docutils literal notranslate"><span class="pre">min2d</span></code>, maximum
value <code class="docutils literal notranslate"><span class="pre">max2d</span></code>, and median value <code class="docutils literal notranslate"><span class="pre">median2d</span></code> at each pixel along the sequence
of available exposures. On the vertical axis of the previous figure, the
difference between the <code class="docutils literal notranslate"><span class="pre">median2d</span></code> and <code class="docutils literal notranslate"><span class="pre">min2d</span></code> of each pixel is shown, while
the horizontal axis displays <code class="docutils literal notranslate"><span class="pre">min2d</span> <span class="pre">-</span> <span class="pre">bias</span></code>.  The different solid lines correspond
to the result of performing numerical simulations using the gain, readout
noise, bias, and the minimum and maximum flatfield values. These simulations
are computed for discrete values of <code class="docutils literal notranslate"><span class="pre">min2d</span> <span class="pre">-</span> <span class="pre">bias</span></code> (represented as filled
circles overimposed on the lines).  For each of these values, the percentiles
50 and 98 are computed. Since the simulated values are unavoidably noisy, the
predictions are fitted using splines (dashed lines, which are difficult to see
unless a zoom is performed). The exclusion boundary (orange line) is computed
by extending the difference between the spline fit to the percentiles 98 and 50
beyond the spline fit to the percentile 98. This extension is controlled by a
parameter named <code class="docutils literal notranslate"><span class="pre">times_boundary_extension</span></code> (see below).  Pixels that lie
above the calculated exclusion boundary and above a minimum threshold in the
vertical axis of the figure (dotted gray line) are initially flagged as
suspected of having been hit by a cosmic ray in more than one exposure.  An
additional requirement (not shown) is imposed: the considered pixel must have a
<code class="docutils literal notranslate"><span class="pre">max2d</span></code> value above three times the readout noise (this avoids pixels with
negative signal very close to the bias level in the raw images). The final set
of suspected pixels are plotted with red x’s in the figure, with the total
number of pixels displayed in the legend.</p>
<p><strong>The signal in the suspected pixels is replaced, in the</strong> <code class="docutils literal notranslate"><span class="pre">median2d</span></code>
<strong>image, by the corresponding</strong> <code class="docutils literal notranslate"><span class="pre">min2d</span></code> <strong>value.</strong> This means that the
resulting image is identical to <code class="docutils literal notranslate"><span class="pre">median2d</span></code>, except for those corrected
pixels.</p>
<p>To apply this combination method, it is necessary to explicitly specify that
<code class="docutils literal notranslate"><span class="pre">mediancr</span></code> should be used (instead of the default <code class="docutils literal notranslate"><span class="pre">median</span></code> method)
in the requirements list of the observation result file. For example:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8_LcbImage_LR-R</span>
<span class="linenos"> 2</span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MegaraLcbImage</span>
<span class="linenos"> 3</span><span class="nt">instrument</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MEGARA</span>
<span class="linenos"> 4</span><span class="nt">frames</span><span class="p">:</span>
<span class="linenos"> 5</span><span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0003978527-20231115-MEGARA-MegaraLcbImage.fits</span>
<span class="linenos"> 6</span><span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0003978528-20231115-MEGARA-MegaraLcbImage.fits</span>
<span class="linenos"> 7</span><span class="w"> </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0003978529-20231115-MEGARA-MegaraLcbImage.fits</span>
<span class="linenos"> 8</span><span class="nt">requirements</span><span class="p">:</span>
<span class="hll"><span class="linenos"> 9</span><span class="w"> </span><span class="nt">method</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mediancr</span>
</span><span class="hll"><span class="linenos">10</span><span class="w"> </span><span class="nt">method_kwargs</span><span class="p">:</span>
</span><span class="hll"><span class="linenos">11</span><span class="w">   </span><span class="nt">find_double_cr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
</span><span class="hll"><span class="linenos">12</span><span class="w">   </span><span class="nt">gain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.6</span>
</span><span class="hll"><span class="linenos">13</span><span class="w">   </span><span class="nt">rnoise</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.5</span>
</span><span class="hll"><span class="linenos">14</span><span class="w">   </span><span class="nt">bias</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
</span><span class="hll"><span class="linenos">15</span><span class="w">   </span><span class="nt">flatmin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5</span>
</span><span class="hll"><span class="linenos">16</span><span class="w">   </span><span class="nt">flatmax</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.5</span>
</span><span class="hll"><span class="linenos">17</span><span class="w">   </span><span class="nt">knots_splfit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</span><span class="hll"><span class="linenos">18</span><span class="w">   </span><span class="nt">nsimulations</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10000</span>
</span><span class="hll"><span class="linenos">19</span><span class="w">   </span><span class="nt">times_boundary_extension</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
</span><span class="hll"><span class="linenos">20</span><span class="w">   </span><span class="nt">threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span>
</span><span class="hll"><span class="linenos">21</span><span class="w">   </span><span class="nt">minimum_max2d_rnoise</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5.0</span>
</span><span class="hll"><span class="linenos">22</span><span class="w">   </span><span class="nt">interactive</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
</span><span class="hll"><span class="linenos">23</span><span class="w">   </span><span class="nt">dilation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span class="hll"><span class="linenos">24</span><span class="w">   </span><span class="nt">plots</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
</span><span class="hll"><span class="linenos">25</span><span class="w">   </span><span class="nt">semiwindow</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15</span>
</span><span class="hll"><span class="linenos">26</span><span class="w">   </span><span class="nt">color_scale</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">minmax</span>
</span><span class="hll"><span class="linenos">27</span><span class="w">   </span><span class="nt">maxplots</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-1</span>
</span><span class="linenos">28</span><span class="w"> </span><span class="nt">extraction_offset</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">+3.0</span><span class="p p-Indicator">]</span>
<span class="linenos">29</span><span class="w"> </span><span class="nt">reference_extinction</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">extinction_LP.txt</span>
<span class="linenos">30</span><span class="w"> </span><span class="nt">ignored_sky_bundles</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">96</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="c1">#[93, 94, 96, 97, 99, 100]</span>
</pre></div>
</div>
<p>It is important to note that, in addition to specifying the method as <code class="docutils literal notranslate"><span class="pre">method:</span>
<span class="pre">mediancr</span></code>, some additional parameters must also be provided under the
<code class="docutils literal notranslate"><span class="pre">method_kwargs:</span></code> key, in particular:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">find_double_cr</span></code> (default True): if True, apply the double cosmic ray
detection algorithm. If False, the function will only compute the median
without detecting double cosmic rays.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gain</span></code>: detector gain (electron/ADU). Although the MEGARA detector
exhibits two different gains (1.60 and 1.73; one value for each detector
half), here we can use a single value.  This is not critical because the two
values are not very different and the detection criterium is more sensitive
to the following parameters.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rnoise</span></code>: readout noise (ADU)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bias</span></code> (default value 0.0): bias value (ADU). <strong>This must be set to zero
for MEGARA because the code that applies the mediancr method receives
preprocessed exposures where the bias level has already been subtracted.</strong></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">flatmin</span></code> (default 1.0): minimum simulated normalized flatfield value.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">flatmax</span></code> (default 1.0): maximum simulated normalized flatfield value.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">knots_splfit</span></code> (default 3): number of inner knots employed in the spline
fit to the simulated boundary data.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nsimulations</span></code> (default 10000): number of simulations to perform for each
point in the exclusion boundary.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">times_boundary_extension</span></code> (default 3.0): number of times that the vertical
distance between the percentiles 98 and 50 of the simulated data is employed
to define the exclusion boundary beyond the percentile 98.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">threshold</span></code> (default Null; this value in the YAML file is converted to None
in Python): minimum threshold for <code class="docutils literal notranslate"><span class="pre">median2d</span> <span class="pre">-</span> <span class="pre">min2d</span></code> to consider a pixel as
a double cosmic ray. If None, the threshold is computed automatically from
the minimum boundary value in the numerical simulations.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">minimum_max2d_rnoise</span></code> (default 5.0): minimum value of <code class="docutils literal notranslate"><span class="pre">max2d</span></code> in
readout noise units to consider a pixel as a double cosmic ray. This avoids
false positives when a pixel exhibits a large negative value in one of the
individual exposures.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">interactive</span></code> (default False): if True, the code generates an interactive
matplotlib plot with the diagnostic diagram (allowing the user to use the
zoom and pan buttons). It is very convenient to set this parameter to True,
interactively examine the diagnostic diagram, stop the program execution, and
try changing the values of <code class="docutils literal notranslate"><span class="pre">flatmin</span></code>, <code class="docutils literal notranslate"><span class="pre">flatmax</span></code>,
<code class="docutils literal notranslate"><span class="pre">times_boundary_extension</span></code> and <code class="docutils literal notranslate"><span class="pre">threshold</span></code>. Other parameters such as
<code class="docutils literal notranslate"><span class="pre">rnoise</span></code> and <code class="docutils literal notranslate"><span class="pre">gain</span></code> can also be modified, although the user should take
into account that the objective is to find an automatic way to select
uncorrected cosmic rays, not to make use of realistic values of gain, readout
noise or flatfield variation. Note that the values of <code class="docutils literal notranslate"><span class="pre">flatmin</span></code> and
<code class="docutils literal notranslate"><span class="pre">flatmax</span></code> can be used to allow the simulations to account, to some extent,
for the effect of signal variations in different MEGARA exposures. This can
happen, for example, in sky lines (when exposure times are long), or due to
small shifts in the telescope pointing.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dilation</span></code> (default 1): the pixels composing each cosmic ray can be
surrounded by a dilation factor, which expands the mask around the detected
cosmic ray pixels. A value of zero means that no dilation is applied.
Typically a value of 1 is useful, since it allow to replace the tails of
cosmic rays (whose pixels exhibit a lower signal).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">plots</span></code> (default False): if True, a PDF file called
<code class="docutils literal notranslate"><span class="pre">mediancr_identified_cr.pdf</span></code> is generated with the individual double cosmic
rays identified. Note that enabling this option may introduce a noticeable
penalty in execution time.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">semiwindow</span></code> (default 15): the semiwindow size to plot the double cosmic
rays. Only used if <code class="docutils literal notranslate"><span class="pre">plots</span></code> is True.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">color_scale</span></code> (default minmax): the color scale employed in the
<code class="docutils literal notranslate"><span class="pre">mediancr_identified_cr.pdf</span></code> images. Only used if <code class="docutils literal notranslate"><span class="pre">plots</span></code> is True. The
valid options are minmax and zscale.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">maxplots</span></code> (default 10): the maximum number of suspicious double cosmic
rays to display. Note that setting a limit is useful when experimenting with
the previous values of <code class="docutils literal notranslate"><span class="pre">gain</span></code>, <code class="docutils literal notranslate"><span class="pre">rnoise</span></code>, etc., as it prevents generating
an excessively large number of plots due to false positive detections. A
negative value indicates that all the suspected double CR are displayed. This
option is only used if <code class="docutils literal notranslate"><span class="pre">plots</span></code> is True.</p></li>
</ul>
<p>Pixels suspected of having been affected by cosmic rays in two of the
available exposures are grouped when they form a connected cluster. These are
then sorted using the detection criteria, so they can be displayed in order,
starting with the pixels most likely to have been affected by two cosmic rays.
For each case, a figure like the one shown below is generated.</p>
<a class="reference internal image-reference" href="_images/mediancr_identified_cr.png"><img alt="example of pixels affected by two cosmic rays in a group of 3 exposures" src="_images/mediancr_identified_cr.png" style="width: 100%;" />
</a>
<p>The first row shows the three individual exposures available in this example.
In the second row, the left image presents the simple median combination, the
center image shows the pixels detected as affected by two cosmic rays
(surrounded by a 1-pixel-wide border), and the right image displays the median
combination with the affected pixels replaced by the minimum value from the
individual exposures.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="healtraces.html" class="btn btn-neutral float-left" title="Healing Defective Traces" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="megaratools.html" class="btn btn-neutral float-right" title="MEGARA Tools" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2025, Universidad Complutense de Madrid.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>